<html>
    <head>
        <title>Fish Chat!</title>
        <script src="/socket.io/socket.io.js"></script>
        <script src="/js/jquery-1.9.1.min.js"></script>
        <script src="/js/util.js"></script>
        <link rel="stylesheet" href="/css/chat.css" type="text/css" />

        <script>
            var socket = io.connect('http://192.168.2.117:1024');
           var sent = {count: 0, packets: {}};
           var recv = {count: 0, packets: {}};
           
            socket.on('connected', function(data)
            {
                $('.status').html('Awaiting input');
                var name = prompt('Welcome friend! What is your name?');

                // Usernames are optional, creeper
                if(name)
                {
                    $('.status').html('Awaiting response');
                    socket.emit('name', {name: name});
                }
            });
            
            socket.on('error', function(data)
            {
                alert('You done messed up: \n'+data.message)
            });
            
            socket.on('count', function(data)
            {
                if(data.count == 1)
                    $('h1').html(data.count+' user connected');
                else
                    $('h1').html(data.count+' users connected');
            });
            
            socket.on('users', function(users)
            {
                $('.status').html('Connected');
                $('.users').html(users.list.join(' '));
            });
            
            socket.on('chat', function(chat)
            {
                $('.chat').append("<div><b>"+chat.user+"</b>: "+chat.message.fishformat()+"</div>");
                setTimeout(function() { $('.chat').scrollTop($('.chat')[0].scrollHeight) }, 100);
            });
            
            socket.on('packet', function(packet)
            {
                packet.data = packet.data.replace(/[\r\n ]/g, '');

                var header = packet.data.substr(4, 4);
                                
                if(packet.source == 'client')
                {
                    sent.count++;
                    $('.count .sent').text(sent.count);

                    // Emotes?
                    if(header == '0111')
                        console.log(packet);
                    
                    // Movement?
                    if(header == '0154')
                        console.log(packet);
                    
                    if(typeof sent.packets[header] === 'undefined')
                        sent.packets[header] = {data: packet.data, count: 1};
                    else
                        sent.packets[header].count++;
                }
                else if(packet.source == 'server')
                {
                    recv.count++;
                    $('.count .recv').text(recv.count);
                 
                    //if(packet.host == '128.241.94.45')
                    //    console.log(packet);                        
                    
                    // Emotes?
                    if(header == '0115')
                        console.log(packet);
                    
                    if(typeof recv.packets[header] === 'undefined')
                        recv.packets[header] = {data: packet.data, count: 1};
                    else
                        recv.packets[header].count++;
                }
            });
            
            $(document).ready(function()
            {
                $('.chat').css('max-height', $('body').height() - 150);

                $(window).resize(function()
                {
                    $('.chat').css('max-height', $('body').height() - 150);
                    $('.chat').scrollTop($('.chat')[0].scrollHeight);
                });
                
                $('body').on('click', '.chat a', function()
                {
                    $(this).attr('target', '_blank');
                });
                                
                $('.input').keypress(function(event)
                {
                    if(event.which == 13)
                        $('.message').trigger('click');
                });
                
                $('.message').click(function()
                {
                    var message = $('.input').val();
                    var command = message.split(' ');
                    
                    if(command[0] == 'stats')
                    {
                        // Initialize 
                        sent.sorted = [];
                        recv.sorted = [];
                        
                        // Loop
                        for(var header in sent.packets)
                        {
                            sent.sorted.push([header, sent.packets[header].count]);
                        }
                        
                        for(var header in recv.packets)
                        {
                            recv.sorted.push([header, recv.packets[header].count]);
                        }
                        
                        // Sort
                        sent.sorted = sent.sorted.sort(function(a, b) {return a[1] - b[1]});
                        recv.sorted = recv.sorted.sort(function(a, b) {return a[1] - b[1]});
                        
                        // Clear space
                        $('.packets .sent').html('');
                        $('.packets .recv').html('');
                        
                        for(var i in sent.sorted)
                        {
                            console.log(sent.sorted);
                            
                            var header = sent.sorted[i][0];
                            var data = sent.packets[header];
                            
                            console.log(header);
                            console.log(data);
                            $('.packets .sent').append("<div class='packet' title='"+data.data+"'>"+ header +" - "+data.count+"</div>");
                        }
                        
                        for(var i in recv.sorted)
                        {
                            var header = recv.sorted[i][0];
                            var data = recv.packets[header];
                            
                            console.log(header);
                            console.log(data);

                            $('.packets .recv').append("<div class='packet' title='"+data.data+"'>"+ header +" - "+data.count+"</div>");
                        }
                    }

                    socket.emit('chat', {message: message});
                    $('.input').val('');
                });
                

                function hex2a(hex) {
                    var str = '';
                    for (var i = 0; i < hex.length; i += 2)
                        str += String.fromCharCode(parseInt(hex.substr(i, 2), 16));
                    return str;
                }

                $('.packets').on('click', '.packet', function()
                {
                    socket.emit('chat', {message: $(this).attr('title')});
                    socket.emit('chat', {message: hex2a($(this).attr('title'))});

                });
            });
        </script>
    </head>
    
    <body>
        <div class='right count'>
            <div>Packets sent: <span class='sent'>0</span></div>
            <div>Packets recv: <span class='recv'>0</span></div>
        </div>
        
        <h1>Loading...</h1>
        <div class='users'></div>
        <hr />

        <div class='right packets'>
            <p>Sent:</p>
            <div class='sent'></div>
            
            <p>Recieved:</p>
            <div class='recv'></div>
        </div>
        
        <div class='chat'></div>
        
        <div class='footer'>
            <div class='status'></div>
            <input class='input'> <input type='button' class='message' value='Say'>
        </div>
    </body>
</html>
